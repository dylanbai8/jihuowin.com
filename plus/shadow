# 检查当前是否以管理员权限运行
$isAdmin = [Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()
$adminRole = [Security.Principal.WindowsBuiltInRole]::Administrator

# 设置控制台标题和颜色
$Host.UI.RawUI.WindowTitle = "-- PowerShadow --"
Write-Host "`nConfiguring console..."
$Console = $Host.UI.RawUI
$Console.WindowSize = New-Object System.Management.Automation.Host.Size(53, 9)
$Console.BufferSize = New-Object System.Management.Automation.Host.Size(53, 500)
$Console.BackgroundColor = "Black"
$Console.ForegroundColor = "Green"
Clear-Host

# 主菜单
Function Show-Menu {
    Clear-Host
    Write-Host "          ===== PowerShadow =====" -ForegroundColor Green
    Write-Host ""
    Write-Host "   --[1]-- Turn-on PowerShadow" -ForegroundColor Green
    Write-Host "   --[2]-- Turn-off PowerShadow" -ForegroundColor Green
    Write-Host ""
    $choice = Read-Host "Enter[1-2]"
    Switch ($choice) {
        "1" { Enable-PowerShadow }
        "2" { Disable-PowerShadow }
        Default { Show-Menu }
    }
}

# 启用 PowerShadow
Function Enable-PowerShadow {
    Clear-Host
    Write-Host "Checking for UWF component..." -ForegroundColor Green

    # 检查是否已启用 UWF 组件
    $uwfInstalled = (Get-WindowsOptionalFeature -Online -FeatureName Client-Pro | Where-Object {$_.State -eq "Enabled"}).Count -gt 0

    If (-Not $uwfInstalled) {
        Write-Host "UWF component is not installed. Installing..." -ForegroundColor Yellow
        Enable-WindowsOptionalFeature -Online -FeatureName Client-Pro -NoRestart

        If ($?) {
            Write-Host "UWF component installed successfully. Please restart and rerun the script." -ForegroundColor Green
            Exit
        } Else {
            Write-Host "Failed to install UWF component. Please check your system configuration." -ForegroundColor Red
            Exit
        }
    } Else {
        Write-Host "UWF component is already installed." -ForegroundColor Green
    }

    # 启用 PowerShadow 设置
    Write-Host "Enabling PowerShadow..." -ForegroundColor Green
    uwfmgr filter enable
    uwfmgr volume protect c:
    uwfmgr file add-exclusion $env:USERPROFILE\Downloads

    uwfmgr overlay set-size 2048
    uwfmgr overlay set-warningthreshold 1848
    uwfmgr overlay set-criticalthreshold 2000

    Write-Host "`nComplete, restart your computer!" -ForegroundColor Green
    Start-Sleep -Seconds 2
    Exit
}


# 禁用 PowerShadow
Function Disable-PowerShadow {
    Clear-Host
    Write-Host "Disabling PowerShadow..." -ForegroundColor Green
    uwfmgr filter disable

    Write-Host "`nComplete, restart your computer!" -ForegroundColor Green
    Start-Sleep -Seconds 2
    Exit
}

# 显示菜单
Show-Menu



if ($isAdmin.IsInRole($adminRole)) {

} else {
    Write-Warning "Please run Powershell as administrator."
}

