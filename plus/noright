# 检查当前是否以管理员权限运行
$isAdmin = [Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()
$adminRole = [Security.Principal.WindowsBuiltInRole]::Administrator

# 禁用右键菜单的方法
function Disable-ContextMenuHandlers {
    param (
        [string]$RegistryPath
    )

    # 获取所有项
    $keys = Get-ChildItem -Path "Registry::$RegistryPath" -ErrorAction SilentlyContinue

    foreach ($key in $keys) {
        try {
            # 禁用右键菜单项
            $keyPath = $key.PSPath
            Rename-Item -Path $keyPath -NewName ($key.Name + "_Disabled") -ErrorAction SilentlyContinue
            Write-Host "已禁用：$($key.Name)" -ForegroundColor Green
        } catch {
            Write-Host "无法禁用：$($key.Name)" -ForegroundColor Red
        }
    }
}

if ($isAdmin.IsInRole($adminRole)) {

# 执行禁用
Write-Host "正在禁用右键菜单..." -ForegroundColor Yellow

# 禁用文件相关的右键菜单
Disable-ContextMenuHandlers -RegistryPath "HKEY_CLASSES_ROOT\*\shellex\ContextMenuHandlers"

# 禁用文件夹相关的右键菜单
Disable-ContextMenuHandlers -RegistryPath "HKEY_CLASSES_ROOT\Directory\shellex\ContextMenuHandlers"

Write-Host "所有第三方右键菜单已禁用！" -ForegroundColor Cyan

} else {
    Write-Warning "Please run Powershell as administrator."
}


