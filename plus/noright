# 检查当前是否以管理员权限运行
$isAdmin = [Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()
$adminRole = [Security.Principal.WindowsBuiltInRole]::Administrator

if ($isAdmin.IsInRole($adminRole)) {

# 定义需要处理的注册表路径
$registryPaths = @(
    "HKCR\*\shellex\ContextMenuHandlers",
    "HKCR\Directory\shellex\ContextMenuHandlers",
    "HKCR\Drive\shellex\ContextMenuHandlers",
    "HKCR\Folder\shellex\ContextMenuHandlers",
    "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Shell Extensions\Approved"
)

# 定义备份目录
$backupDir = Join-Path -Path ([Environment]::GetFolderPath("MyDocuments")) -ChildPath "ContextMenuBackup"
if (-not (Test-Path -Path $backupDir)) {
    New-Item -ItemType Directory -Path $backupDir | Out-Null
}

# 快速处理注册表键
foreach ($path in $registryPaths) {
    # Write-Host "处理路径: $path" -ForegroundColor Yellow
    try {
        $keys = Get-ChildItem -Path "Registry::$path" -ErrorAction Stop
        foreach ($key in $keys) {
            # 系统项通常为 GUID 格式，跳过这些项
            if ($key.PSChildName -notmatch "^\{[0-9a-fA-F\-]{36}\}$") {
                # Write-Host "备份并禁用: $($key.PSChildName)" -ForegroundColor Green

                # 构造备份文件路径
                $sanitizedName = $key.PSChildName -replace "[\\/:*?""<>|]", "_"
                $backupFile = Join-Path -Path $backupDir -ChildPath "$sanitizedName.reg"

                # 转换路径为标准注册表格式
                $regPath = $key.PSPath.Replace("HKEY_CLASSES_ROOT", "HKCR").Replace("HKEY_LOCAL_MACHINE", "HKLM").Replace("Registry::", "")

                # 备份注册表项
                try {
                    reg export "$regPath" "$backupFile" > $null
                } catch {
                    # Write-Host "备份失败: $regPath" -ForegroundColor Red
                }

                # 删除该项
                try {
                    Remove-Item -Path $key.PSPath -Recurse -Force -ErrorAction Stop
                } catch {
                    # Write-Host "无法删除项: $($key.PSPath)" -ForegroundColor Red
                }
            }
        }
    } catch {
        # Write-Host "跳过路径或处理失败: $path" -ForegroundColor Red
    }
}

# Write-Host "非系统右键菜单已禁用，并备份至 $backupDir" -ForegroundColor Cyan

} else {
    Write-Warning "Please run Powershell as administrator."
}

