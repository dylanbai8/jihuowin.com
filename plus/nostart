# 检查当前是否以管理员权限运行
$isAdmin = [Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()
$adminRole = [Security.Principal.WindowsBuiltInRole]::Administrator


# 禁用所有开机自启动项
function Disable-StartupItems {
    # 获取注册表中开机启动项
    $startupKeys = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run",
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
    )

    foreach ($key in $startupKeys) {
        try {
            $items = Get-ItemProperty -Path $key
            $itemNames = $items.PSObject.Properties.Name | Where-Object { $_ -ne "PSPath" -and $_ -ne "PSParentPath" -and $_ -ne "PSChildName" -and $_ -ne "PSProvider" }
            foreach ($itemName in $itemNames) {
                # Write-Output "Disabling startup item: $itemName"
                Remove-ItemProperty -Path $key -Name $itemName -ErrorAction Stop
            }
        } catch {}
    }

    # 禁用开机启动文件夹中的项
    $startupFolders = @(
        [Environment]::GetFolderPath("CommonStartup"),
        [Environment]::GetFolderPath("Startup")
    )

    foreach ($folder in $startupFolders) {
        # Write-Output "Processing startup folder: $folder"
        try {
            $files = Get-ChildItem -Path $folder -File
            foreach ($file in $files) {
                Remove-Item -Path $file.FullName -ErrorAction Stop
            }
        } catch {}
    }

    Write-Output "All startup items have been disabled."
}


# 主逻辑
if ($isAdmin.IsInRole($adminRole)) {
    Disable-StartupItems
} else {
    Write-Host "Please run Powershell as administrator."
}


# 计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
# 计算机\HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

# C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
# C:\Users\admin\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup

